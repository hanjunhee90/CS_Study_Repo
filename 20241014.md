# π“ [tech7-μ¤ν”„λ§] μμ—… λ‚΄μ© μ •λ¦¬

## λ©μ°¨
1. [μμ—… κ°μ”](#μμ—…-κ°μ”)
2. [μ£Όμ” κ°λ…](#μ£Όμ”-κ°λ…)
3. [μ‹¤μµ λ° μμ ](#μ‹¤μµ-λ°-μμ )
4. [μ°Έκ³  μλ£](#μ°Έκ³ -μλ£)
5. [μ§λ¬Έ λ° λ‹µλ³€](#μ§λ¬Έ-λ°-λ‹µλ³€)

---

## μμ—… κ°μ”
**λ‚ μ§:** 2024λ…„ 10μ›” 14μΌ  
**κ°•μ‚¬:** [nick]  
**μ£Όμ :** [spring framework μ±„ν…]  

 - sockJS, STOMP

---
<!-- ![spring](./img/spring.svg) -->

## μ£Όμ” κ°λ…


### SockJSμ™€ STOMP κ°λ… λ° μ‚¬μ©λ²•

#### 1. **SockJS**
- **μ •μ**: SockJSλ” μ›Ή λΈλΌμ°μ €μ™€ μ›Ή μ„λ²„ κ°„μ μ‹¤μ‹κ°„ ν†µμ‹ μ„ κ°€λ¥ν•κ² ν•λ” λΌμ΄λΈλ¬λ¦¬λ΅, WebSocketμ κΈ°λ¥μ„ μ—λ®¬λ μ΄μ…ν•©λ‹λ‹¤. WebSocketμ„ μ§€μ›ν•μ§€ μ•λ” ν™κ²½μ—μ„λ„ μ‹¤μ‹κ°„ ν†µμ‹ μ„ ν•  μ μλ„λ΅ λ•μµλ‹λ‹¤.
- **μ‚¬μ©λ²•**: Springμ—μ„ SockJSλ” μ‹¤μ‹κ°„ μ–‘λ°©ν–¥ ν†µμ‹ μ„ μ„ν•΄ μ¶”κ°€λλ” μμ΅΄μ„±μ…λ‹λ‹¤. μ£Όλ΅ μ±„ν… μ• ν”λ¦¬μΌ€μ΄μ…μ²λΌ μ‹¤μ‹κ°„ λ°μ΄ν„°λ¥Ό μ£Όκ³ λ°›μ•„μ•Ό ν•λ” μƒν™©μ—μ„ μ‚¬μ©λ©λ‹λ‹¤. WebSocketμ„ λ¨λ“  λΈλΌμ°μ €μ—μ„ μ§€μ›ν•μ§€ μ•κΈ° λ•λ¬Έμ—, SockJSκ°€ μ΄λ¥Ό λ³΄μ™„ν•΄ μ¤λ‹λ‹¤.

#### 2. **STOMP**
- **μ •μ**: STOMP(Simple Text Oriented Messaging Protocol)λ” ν…μ¤νΈ κΈ°λ° λ©”μ‹μ§• ν”„λ΅ν† μ½λ΅, λ©”μ‹μ§€ λΈλ΅μ»¤μ™€ ν΄λΌμ΄μ–ΈνΈ κ°„μ ν†µμ‹ μ„ κ΄€λ¦¬ν•©λ‹λ‹¤. WebSocketμ„ ν†µν•΄ μ „μ†΅λλ” λ©”μ‹μ§€λ¥Ό κµ¬μ²΄μ μΈ κµ¬λ¬Έ ν•μ‹μΌλ΅ μ²λ¦¬ν•μ—¬ μ‹¤μ‹κ°„ ν†µμ‹ μ„ μ²΄κ³„μ μΌλ΅ κ΄€λ¦¬ν•©λ‹λ‹¤.
- **μ‚¬μ©λ²•**: Springμ—μ„λ” STOMPλ¥Ό ν†µν•΄ WebSocketμ„ κΈ°λ°μΌλ΅ ν• μ±„ν… κΈ°λ¥μ„ κµ¬ν„ν•  μ μμµλ‹λ‹¤. ν΄λΌμ΄μ–ΈνΈμ™€ μ„λ²„ κ°„μ λ©”μ‹μ§€ μ „μ†΅μ„ ν¨μ¨μ μΌλ΅ κ΄€λ¦¬ν•κ³ , λΈλ΅μ»¤λ¥Ό ν†µν•΄ μ—¬λ¬ ν΄λΌμ΄μ–ΈνΈμ— λ©”μ‹μ§€λ¥Ό λ°μ†΅ν•  μ μμµλ‹λ‹¤.

#### 3. **Springμ„ ν™μ©ν• μ‚¬μ©λ²•**
### κ° μ½”λ“ λΈ”λ΅μ μ—­ν•  μ„¤λ…

#### 1. `@Configuration` λ° `@EnableWebSocketMessageBroker`
- **μ—­ν• **: 
  - `@Configuration`: Springμ—μ„ μ΄ ν΄λμ¤κ°€ μ„¤μ •μ„ λ‹΄λ‹Ήν•λ” ν΄λμ¤λ¥Ό λ‚νƒ€λƒ…λ‹λ‹¤.
  - `@EnableWebSocketMessageBroker`: WebSocket λ©”μ‹μ§€ λΈλ΅μ»¤λ¥Ό ν™μ„±ν™”ν•©λ‹λ‹¤. STOMP ν”„λ΅ν† μ½μ„ μ‚¬μ©ν•λ” WebSocket κΈ°λ°μ λ©”μ‹μ§• μ• ν”λ¦¬μΌ€μ΄μ…μ„ μ„¤μ •ν•  λ• μ‚¬μ©λ©λ‹λ‹¤.

#### 2. `registerStompEndpoints(StompEndpointRegistry registry)`
- **μ—­ν• **:
  - WebSocketμ„ μ„ν• μ—”λ“ν¬μΈνΈλ¥Ό μ„¤μ •ν•©λ‹λ‹¤.
  - `"/endpoint"`λ” ν΄λΌμ΄μ–ΈνΈκ°€ μ²μ WebSocketμ— μ—°κ²°ν•  λ• μ‚¬μ©ν•  μ—”λ“ν¬μΈνΈμ…λ‹λ‹¤.
  - `withSockJS()`λ” WebSocketμ„ μ§€μ›ν•μ§€ μ•λ” λΈλΌμ°μ €μ—μ„λ„ SockJSλ¥Ό ν†µν•΄ λ€μ²΄ μ—°κ²°μ„ ν•  μ μλ„λ΅ μ„¤μ •ν•©λ‹λ‹¤.
  - **μ¦‰, WebSocket μ—°κ²°μ΄ λ¶κ°€λ¥ν• ν™κ²½μ—μ„λ„ μ•μ „ν•κ² ν†µμ‹ μ„ μ μ§€ν•  μ μκ² ν•©λ‹λ‹¤.**
  - 
  ```java
  	@Override
  	public void registerStompEndpoints(StompEndpointRegistry registry) {
  		registry.addEndpoint("/endpoint").withSockJS();
  	}
  ```

#### 3. `configureMessageConverters(List<MessageConverter> messageConverters)`
- **μ—­ν• **:
  - λ©”μ‹μ§€ λ³€ν™κΈ°λ¥Ό μ„¤μ •ν•λ” λ¶€λ¶„μ…λ‹λ‹¤. λ©”μ‹μ§€ λ³€ν™κΈ°λ” μ„λ²„μ™€ ν΄λΌμ΄μ–ΈνΈ κ°„μ λ°μ΄ν„°λ¥Ό λ‹¤μ–‘ν• ν¬λ§·(JSON, XML λ“±)μΌλ΅ λ³€ν™ν•΄μ¤λ‹λ‹¤.
  - `return true`λ΅ μ„¤μ •λ κ²ƒμ€ μ»¤μ¤ν…€ λ©”μ‹μ§€ λ³€ν™κΈ°λ¥Ό μ‚¬μ©ν•μ§€ μ•κ³ , κΈ°λ³Έ λ©”μ‹μ§€ λ³€ν™κΈ°λ¥Ό κ·Έλ€λ΅ μ‚¬μ©ν•  λ• μ“°μ…λ‹λ‹¤.
  - 
```java
  @Override
	public boolean configureMessageConverters(List<MessageConverter> messageConverters) {
		return true; 
	}
```
#### 4. `configureMessageBroker(MessageBrokerRegistry registry)`
- **μ—­ν• **:
  - λ©”μ‹μ§€ λΈλ΅μ»¤μ μ„¤μ •μ„ λ‹΄λ‹Ήν•©λ‹λ‹¤.
  - `enableSimpleBroker("/subscribe")`: ν΄λΌμ΄μ–ΈνΈμ—μ„ `/subscribe`λ΅ μ‹μ‘ν•λ” κ²½λ΅λ΅ λ³΄λ‚΄μ§„ λ©”μ‹μ§€λ¥Ό λΈλ΅μ»¤κ°€ λΌμ°ν…ν•κ² ν•©λ‹λ‹¤. μλ¥Ό λ“¤μ–΄, μ±„ν… λ©”μ‹μ§€λ¥Ό νΉμ • κµ¬λ… κ²½λ΅λ΅ μ „λ‹¬ν•  λ• μ‚¬μ©λ©λ‹λ‹¤.
  - `setApplicationDestinationPrefixes("/app")`: ν΄λΌμ΄μ–ΈνΈμ—μ„ μ„λ²„λ΅ λ³΄λ‚Έ λ©”μ‹μ§€λ¥Ό `/app`μΌλ΅ μ‹μ‘ν•λ” κ²½λ΅λ΅ λ°›μµλ‹λ‹¤. μ΄ λ©”μ‹μ§€λ” μ»¨νΈλ΅¤λ¬μ—μ„ μ²λ¦¬λλ©°, μλ¥Ό λ“¤μ–΄ `/app/hello/roomNo`λ” μ„λ²„μ `/hello/{roomNo}`λ΅ μ „λ‹¬λ©λ‹λ‹¤.
 ```java
   @Override
	 public void configureMessageBroker(MessageBrokerRegistry registry) {
		registry.enableSimpleBroker("/subscribe");
		registry.setApplicationDestinationPrefixes("/app");
	}
```

```java
//μ±„ν… λ©”μ„Έμ§€ μ „λ‹¬
	@MessageMapping("/hello/{roomNo}")  //ν΄λΌμ΄μ–ΈνΈκ°€ μ„λ²„λ΅ λ³΄λ‚΄λ” λ©”μ‹μ§€μ κ²½λ΅λ¥Ό μ •μν•©λ‹λ‹¤.
	@SendTo("/subscribe/chat/{roomNo}") //μ„λ²„κ°€ ν΄λΌμ΄μ–ΈνΈμ—κ² λ³΄λ‚Ό λ©”μ‹μ§€
	public ChatLogVO broadcasting(ChatLogVO chatVO) {
		//μ΄ λ©”μ„λ“λ” ν΄λΌμ΄μ–ΈνΈλ΅λ¶€ν„° λ°›μ€ λ©”μ‹μ§€λ¥Ό μ²λ¦¬ν• ν›„, λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈλ“¤μ—κ² μ „λ‹¬ν•λ” μ—­ν• μ„ ν•©λ‹λ‹¤.
		chatService.insertChat(chatVO);
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy/MM/dd HH:mm");
		chatVO.setSendDate(sdf.format(new Date()));
		// μƒλ€λ°©μ—κ² μ „λ‹¬λ¨.		
		return chatVO;
	}
```

#### 5. `SimpMessagingTemplate`, `handleWebSocketConnectListener(SessionConnectEvent event)`
- **μ—­ν• **:
  - `SimpMessagingTemplate`: Springμ—μ„ STOMPλ¥Ό ν†µν•΄ λ©”μ‹μ§€λ¥Ό νΉμ • λ©μ μ§€λ΅ μ „μ†΅ν•  μ μκ² ν•΄μ£Όλ” ν΄λμ¤μ…λ‹λ‹¤.
  - `handleWebSocketConnectListener`: ν΄λΌμ΄μ–ΈνΈκ°€ WebSocketμ— μ ‘μ†ν•  λ• λ°μƒν•λ” μ΄λ²¤νΈ(SessionConnectEvent)λ¥Ό μ²λ¦¬ν•λ” λ©”μ†λ“μ…λ‹λ‹¤.
    - `StompHeaderAccessor`: STOMP λ©”μ‹μ§€μ ν—¤λ” μ •λ³΄λ¥Ό μ‰½κ² κ°€μ Έμ¤λ„λ΅ λ„μ™€μ£Όλ” λ„κµ¬μ…λ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ `userId`μ™€ `roomId`λ¥Ό κ°€μ Έμ™€μ„ μ ‘μ† μ •λ³΄λ¥Ό κΈ°λ΅ν•©λ‹λ‹¤.
    - μ‚¬μ©μκ°€ μ±„ν…λ°©μ— μ ‘μ†ν•λ©΄, ν•΄λ‹Ή μ •λ³΄λ¥Ό ν†µν•΄ λ‹¤λ¥Έ ν΄λΌμ΄μ–ΈνΈμ—κ² "μ‚¬μ©μκ°€ μ…μ¥ν–μµλ‹λ‹¤"λΌλ” μ•λ¦Ό λ©”μ‹μ§€λ¥Ό `/subscribe/chat/{roomId}` κ²½λ΅λ΅ μ „μ†΅ν•©λ‹λ‹¤.
```java

  @Autowired
	private SimpMessagingTemplate messagingTemplate;
	@EventListener
	public void handleWebSocketConnectListener(SessionConnectEvent event) {
		StompHeaderAccessor sha = StompHeaderAccessor.wrap(event.getMessage());
		String userId = sha.getFirstNativeHeader("userId");
		String roomId = sha.getFirstNativeHeader("roomId");
		
		Map<String, Object> messge = new HashMap<>();
		messge.put("type", "notification");
		messge.put("message", userId + "λ‹μ΄ μ…μ¥ν•μ…¨μµλ‹λ‹¤.");
		messagingTemplate.convertAndSend("/subscribe/chat/" + roomId, messge);
	}
```

- **μ±„ν…λ°© κΈ°λ¥**:
- ν΄λΌμ΄μ–ΈνΈκ°€ μ±„ν…λ°©μ— μ ‘μ†ν•λ©΄ STOMPλ¥Ό ν†µν•΄ λ©”μ‹μ§€λ¥Ό μ†΅μ‹ ν•κ³ , λΈλ΅μ»¤κ°€ λ©”μ‹μ§€λ¥Ό μ—¬λ¬ ν΄λΌμ΄μ–ΈνΈμ—κ² μ „λ‹¬ν•λ” κµ¬μ΅°λ΅ λ™μ‘ν•©λ‹λ‹¤.
- μλ¥Ό λ“¤μ–΄ `/app/hello/roomNo`λ΅ μ”μ²­μ„ λ³΄λ‚΄λ©΄ μ„λ²„ μΈ΅μ—μ„ ν•΄λ‹Ή λ©”μ‹μ§€λ¥Ό μ²λ¦¬ν•κ³ , λΈλ΅μ»¤λ” μ΄λ¥Ό λ‹¤μ‹ κµ¬λ…μλ“¤μ—κ² μ „μ†΅ν•©λ‹λ‹¤.




## μ‹¤μµ μμ  


- websocket

```xml
<dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-websocket</artifactId>
    <version>${org.springframework-version}</version>
</dependency>
<dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-messaging</artifactId>
    <version>${org.springframework-version}</version>
</dependency>
```


## μ°Έκ³  μλ£

- 

## μ§λ¬Έ 
